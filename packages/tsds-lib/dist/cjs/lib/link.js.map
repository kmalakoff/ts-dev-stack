{"version":3,"sources":["link.mjs"],"sourcesContent":["import fs from 'fs';\nimport path from 'path';\nimport mkdirp from 'mkdirp';\nimport Queue from 'queue-cb';\nimport unlink from './unlink.mjs';\n\nconst isWindows = process.platform === 'win32' || /^(msys|cygwin)$/.test(process.env.OSTYPE);\nconst symlinkType = isWindows ? 'junction' : 'dir';\n\nfunction saveLink(target, cb) {\n  const movedPath = path.join(path.dirname(target), `${path.basename(target)}.tsds`);\n  const queue = new Queue(1);\n  queue.defer(fs.rename.bind(null, target, movedPath));\n  queue.defer(createLink.bind(null, target));\n  queue.await(cb);\n}\n\nfunction createLink(target, cb) {\n  const queue = new Queue(1);\n  queue.defer((cb) => {\n    mkdirp(path.dirname(target), () => {\n      cb();\n    });\n  });\n  queue.defer(fs.symlink.bind(null, process.cwd(), target, symlinkType));\n  queue.await(cb);\n}\n\nfunction removeLink(target, cb) {\n  fs.unlink(target, cb);\n}\n\nexport default function link(target, cb) {\n  try {\n    fs.lstat(target, (_, lstat) => {\n      // new\n      if (!lstat) {\n        createLink(target, (err) => {\n          err ? cb(err) : cb(null, removeLink.bind(null, target));\n        });\n      }\n\n      // exists so move it\n      else if (lstat.isDirectory()) {\n        saveLink(target, (err) => {\n          err ? cb(err) : cb(null, unlink.bind(null, target));\n        });\n      }\n\n      // replace\n      else {\n        removeLink(target, () => {\n          createLink(target, (err) => {\n            err ? cb(err) : cb(null, removeLink.bind(null, target));\n          });\n        });\n      }\n    });\n  } catch (err) {\n    return cb(err);\n  }\n}\n"],"names":["link","isWindows","process","platform","test","env","OSTYPE","symlinkType","saveLink","target","cb","movedPath","path","join","dirname","basename","queue","Queue","defer","fs","rename","bind","createLink","await","mkdirp","symlink","cwd","removeLink","unlink","lstat","_","err","isDirectory"],"mappings":";;;;+BAgCA;;;eAAwBA;;;yDAhCT;2DACE;6DACE;8DACD;6DACC;;;;;;AAEnB,IAAMC,YAAYC,QAAQC,QAAQ,KAAK,WAAW,kBAAkBC,IAAI,CAACF,QAAQG,GAAG,CAACC,MAAM;AAC3F,IAAMC,cAAcN,YAAY,aAAa;AAE7C,SAASO,SAASC,MAAM,EAAEC,EAAE;IAC1B,IAAMC,YAAYC,aAAI,CAACC,IAAI,CAACD,aAAI,CAACE,OAAO,CAACL,SAAS,AAAC,GAAwB,OAAtBG,aAAI,CAACG,QAAQ,CAACN,SAAQ;IAC3E,IAAMO,QAAQ,IAAIC,gBAAK,CAAC;IACxBD,MAAME,KAAK,CAACC,WAAE,CAACC,MAAM,CAACC,IAAI,CAAC,MAAMZ,QAAQE;IACzCK,MAAME,KAAK,CAACI,WAAWD,IAAI,CAAC,MAAMZ;IAClCO,MAAMO,KAAK,CAACb;AACd;AAEA,SAASY,WAAWb,MAAM,EAAEC,EAAE;IAC5B,IAAMM,QAAQ,IAAIC,gBAAK,CAAC;IACxBD,MAAME,KAAK,CAAC,SAACR;QACXc,IAAAA,eAAM,EAACZ,aAAI,CAACE,OAAO,CAACL,SAAS;YAC3BC;QACF;IACF;IACAM,MAAME,KAAK,CAACC,WAAE,CAACM,OAAO,CAACJ,IAAI,CAAC,MAAMnB,QAAQwB,GAAG,IAAIjB,QAAQF;IACzDS,MAAMO,KAAK,CAACb;AACd;AAEA,SAASiB,WAAWlB,MAAM,EAAEC,EAAE;IAC5BS,WAAE,CAACS,MAAM,CAACnB,QAAQC;AACpB;AAEe,SAASV,KAAKS,MAAM,EAAEC,EAAE;IACrC,IAAI;QACFS,WAAE,CAACU,KAAK,CAACpB,QAAQ,SAACqB,GAAGD;YACnB,MAAM;YACN,IAAI,CAACA,OAAO;gBACVP,WAAWb,QAAQ,SAACsB;oBAClBA,MAAMrB,GAAGqB,OAAOrB,GAAG,MAAMiB,WAAWN,IAAI,CAAC,MAAMZ;gBACjD;YACF,OAGK,IAAIoB,MAAMG,WAAW,IAAI;gBAC5BxB,SAASC,QAAQ,SAACsB;oBAChBA,MAAMrB,GAAGqB,OAAOrB,GAAG,MAAMkB,eAAM,CAACP,IAAI,CAAC,MAAMZ;gBAC7C;YACF,OAGK;gBACHkB,WAAWlB,QAAQ;oBACjBa,WAAWb,QAAQ,SAACsB;wBAClBA,MAAMrB,GAAGqB,OAAOrB,GAAG,MAAMiB,WAAWN,IAAI,CAAC,MAAMZ;oBACjD;gBACF;YACF;QACF;IACF,EAAE,OAAOsB,KAAK;QACZ,OAAOrB,GAAGqB;IACZ;AACF"}
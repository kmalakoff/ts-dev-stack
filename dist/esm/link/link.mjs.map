{"version":3,"sources":["link.js"],"sourcesContent":["const path = require('path');\nconst fs = require('fs');\nconst Queue = require('queue-cb');\nconst mkdirp = require('mkdirp');\nconst unlink = require('../unlink/unlink');\n\nconst isWindows = process.platform === 'win32' || /^(msys|cygwin)$/.test(process.env.OSTYPE);\nconst symlinkType = isWindows ? 'junction' : 'dir';\n\nfunction saveLink(installPath, cb) {\n  const movedPath = path.join(path.dirname(installPath), `${path.basename(installPath)}.tsds`);\n  const queue = new Queue(1);\n  queue.defer(fs.rename.bind(null, installPath, movedPath));\n  queue.defer(createLink.bind(null, installPath));\n  queue.await(cb);\n}\n\nfunction createLink(installPath, cb) {\n  const queue = new Queue(1);\n  queue.defer((cb) => {\n    mkdirp(path.dirname(installPath), () => {\n      cb();\n    });\n  });\n  queue.defer(fs.symlink.bind(null, process.cwd(), installPath, symlinkType));\n  queue.await(cb);\n}\n\nfunction removeLink(installPath, cb) {\n  fs.unlink(installPath, cb);\n}\n\nmodule.exports = function link(installPath, cb) {\n  try {\n    fs.lstat(installPath, (_, lstat) => {\n      // new\n      if (!lstat) {\n        createLink(installPath, (err) => {\n          err ? cb(err) : cb(null, removeLink.bind(null, installPath));\n        });\n      }\n\n      // exists so move it\n      else if (lstat.isDirectory()) {\n        saveLink(installPath, (err) => {\n          err ? cb(err) : cb(null, unlink.bind(null, installPath));\n        });\n      }\n\n      // replace\n      else {\n        removeLink(installPath, () => {\n          createLink(installPath, (err) => {\n            err ? cb(err) : cb(null, removeLink.bind(null, installPath));\n          });\n        });\n      }\n    });\n  } catch (err) {\n    return cb(err);\n  }\n};\n"],"names":["path","require","fs","Queue","mkdirp","unlink","isWindows","process","platform","test","env","OSTYPE","symlinkType","saveLink","installPath","cb","movedPath","join","dirname","basename","queue","defer","rename","bind","createLink","await","symlink","cwd","removeLink","module","exports","link","lstat","_","err","isDirectory"],"mappings":"AAAA,MAAMA,OAAOC,QAAQ;AACrB,MAAMC,KAAKD,QAAQ;AACnB,MAAME,QAAQF,QAAQ;AACtB,MAAMG,SAASH,QAAQ;AACvB,MAAMI,SAASJ,QAAQ;AAEvB,MAAMK,YAAYC,QAAQC,QAAQ,KAAK,WAAW,kBAAkBC,IAAI,CAACF,QAAQG,GAAG,CAACC,MAAM;AAC3F,MAAMC,cAAcN,YAAY,aAAa;AAE7C,SAASO,SAASC,WAAW,EAAEC,EAAE;IAC/B,MAAMC,YAAYhB,KAAKiB,IAAI,CAACjB,KAAKkB,OAAO,CAACJ,cAAc,GAAGd,KAAKmB,QAAQ,CAACL,aAAa,KAAK,CAAC;IAC3F,MAAMM,QAAQ,IAAIjB,MAAM;IACxBiB,MAAMC,KAAK,CAACnB,GAAGoB,MAAM,CAACC,IAAI,CAAC,MAAMT,aAAaE;IAC9CI,MAAMC,KAAK,CAACG,WAAWD,IAAI,CAAC,MAAMT;IAClCM,MAAMK,KAAK,CAACV;AACd;AAEA,SAASS,WAAWV,WAAW,EAAEC,EAAE;IACjC,MAAMK,QAAQ,IAAIjB,MAAM;IACxBiB,MAAMC,KAAK,CAAC,CAACN;QACXX,OAAOJ,KAAKkB,OAAO,CAACJ,cAAc;YAChCC;QACF;IACF;IACAK,MAAMC,KAAK,CAACnB,GAAGwB,OAAO,CAACH,IAAI,CAAC,MAAMhB,QAAQoB,GAAG,IAAIb,aAAaF;IAC9DQ,MAAMK,KAAK,CAACV;AACd;AAEA,SAASa,WAAWd,WAAW,EAAEC,EAAE;IACjCb,GAAGG,MAAM,CAACS,aAAaC;AACzB;AAEAc,OAAOC,OAAO,GAAG,SAASC,KAAKjB,WAAW,EAAEC,EAAE;IAC5C,IAAI;QACFb,GAAG8B,KAAK,CAAClB,aAAa,CAACmB,GAAGD;YACxB,MAAM;YACN,IAAI,CAACA,OAAO;gBACVR,WAAWV,aAAa,CAACoB;oBACvBA,MAAMnB,GAAGmB,OAAOnB,GAAG,MAAMa,WAAWL,IAAI,CAAC,MAAMT;gBACjD;YACF,OAGK,IAAIkB,MAAMG,WAAW,IAAI;gBAC5BtB,SAASC,aAAa,CAACoB;oBACrBA,MAAMnB,GAAGmB,OAAOnB,GAAG,MAAMV,OAAOkB,IAAI,CAAC,MAAMT;gBAC7C;YACF,OAGK;gBACHc,WAAWd,aAAa;oBACtBU,WAAWV,aAAa,CAACoB;wBACvBA,MAAMnB,GAAGmB,OAAOnB,GAAG,MAAMa,WAAWL,IAAI,CAAC,MAAMT;oBACjD;gBACF;YACF;QACF;IACF,EAAE,OAAOoB,KAAK;QACZ,OAAOnB,GAAGmB;IACZ;AACF"}
{"version":3,"sources":["compileFile.js"],"sourcesContent":["const path = require('path');\nconst fs = require('fs');\nconst Queue = require('queue-cb');\nconst once = require('call-once-fn');\nconst assign = require('just-extend');\nconst mkdirp = require('mkdirp');\n\nconst transformSync = require('ts-swc-loaders/lib/transformSync.js');\n\n// https://github.com/vercel/next.js/blob/20b63e13ab2631d6043277895d373aa31a1b327c/packages/next/taskfile-swc.js#L118-L125\nconst interopClientDefaultExport = [\n  '',\n  \"if ((typeof exports.default === 'function' || (typeof exports.default === 'object' && exports.default !== null)) && typeof exports.default.__esModule === 'undefined') {\",\n  \"  Object.defineProperty(exports.default, '__esModule', { value: true });\",\n  '  for (var key in exports) exports.default[key] = exports[key];',\n  '  module.exports = exports.default;',\n  '}',\n].join('\\n');\n\nmodule.exports = function compileFile(entry, options, callback) {\n  fs.readFile(entry.fullPath, 'utf8', (err, contents) => {\n    if (err) return callback(err);\n    callback = once(callback);\n\n    try {\n      let config = options.config;\n\n      // overrides for cjs\n      if (options.type === 'cjs') {\n        config = assign({}, config);\n        config.config = assign({}, config.config);\n        config.config.compilerOptions = assign({}, config.config.compilerOptions);\n        config.config.compilerOptions.module = 'CommonJS';\n        config.config.compilerOptions.target = 'ES5';\n      }\n\n      const output = transformSync(contents, entry.basename, config);\n      const relname = entry.path.replace(/\\.[^/.]+$/, '');\n      let ext = path.extname(entry.path);\n\n      // patch .mjs imports\n      if (options.type === 'esm') {\n        output.code = output.code.replace(/\\.(js|ts|tsx|mts)';/g, \".mjs';\");\n        output.code = output.code.replace(/\\.(cts)';/g, \".cjs';\");\n        ext = ext === '.cjs' ? ext.replace(/\\.(cts)/, '.cjs') : ext.replace(/\\.(js|ts|tsx|mts)/, '.mjs');\n      } else {\n        output.code = output.code.replace(/\\.(mjs|cjs|ts|tsx|mts|cts)\"\\)/g, '.js\")');\n        output.code += interopClientDefaultExport;\n        ext = ext.replace(/\\.(mjs|cjs|ts|tsx|mts|cts)/, '.js');\n      }\n\n      mkdirp(path.dirname(path.join(options.dest, relname + ext)), () => {\n        const outQueue = new Queue();\n        outQueue.defer(fs.writeFile.bind(null, path.join(options.dest, relname + ext), output.code, 'utf8'));\n        !options.sourceMaps || outQueue.defer(fs.writeFile.bind(null, path.join(options.dest, `${relname + ext}.map`), output.map, 'utf8'));\n        outQueue.await(callback);\n      });\n    } catch (err) {\n      callback(err);\n    }\n  });\n};\n"],"names":["path","require","fs","Queue","once","assign","mkdirp","transformSync","interopClientDefaultExport","join","module","exports","compileFile","entry","options","callback","readFile","fullPath","err","contents","config","type","compilerOptions","target","output","basename","relname","replace","ext","extname","code","dirname","dest","outQueue","defer","writeFile","bind","sourceMaps","map","await"],"mappings":";AAAA,IAAMA,OAAOC,QAAQ;AACrB,IAAMC,KAAKD,QAAQ;AACnB,IAAME,QAAQF,QAAQ;AACtB,IAAMG,OAAOH,QAAQ;AACrB,IAAMI,SAASJ,QAAQ;AACvB,IAAMK,SAASL,QAAQ;AAEvB,IAAMM,gBAAgBN,QAAQ;AAE9B,0HAA0H;AAC1H,IAAMO,6BAA6B;IACjC;IACA;IACA;IACA;IACA;IACA;CACD,CAACC,IAAI,CAAC;AAEPC,OAAOC,OAAO,GAAG,SAASC,YAAYC,KAAK,EAAEC,OAAO,EAAEC,QAAQ;IAC5Db,GAAGc,QAAQ,CAACH,MAAMI,QAAQ,EAAE,QAAQ,SAACC,KAAKC;QACxC,IAAID,KAAK,OAAOH,SAASG;QACzBH,WAAWX,KAAKW;QAEhB,IAAI;YACF,IAAIK,SAASN,QAAQM,MAAM;YAE3B,oBAAoB;YACpB,IAAIN,QAAQO,IAAI,KAAK,OAAO;gBAC1BD,SAASf,OAAO,CAAC,GAAGe;gBACpBA,OAAOA,MAAM,GAAGf,OAAO,CAAC,GAAGe,OAAOA,MAAM;gBACxCA,OAAOA,MAAM,CAACE,eAAe,GAAGjB,OAAO,CAAC,GAAGe,OAAOA,MAAM,CAACE,eAAe;gBACxEF,OAAOA,MAAM,CAACE,eAAe,CAACZ,MAAM,GAAG;gBACvCU,OAAOA,MAAM,CAACE,eAAe,CAACC,MAAM,GAAG;YACzC;YAEA,IAAMC,SAASjB,cAAcY,UAAUN,MAAMY,QAAQ,EAAEL;YACvD,IAAMM,UAAUb,MAAMb,IAAI,CAAC2B,OAAO,CAAC,aAAa;YAChD,IAAIC,MAAM5B,KAAK6B,OAAO,CAAChB,MAAMb,IAAI;YAEjC,qBAAqB;YACrB,IAAIc,QAAQO,IAAI,KAAK,OAAO;gBAC1BG,OAAOM,IAAI,GAAGN,OAAOM,IAAI,CAACH,OAAO,CAAC,wBAAwB;gBAC1DH,OAAOM,IAAI,GAAGN,OAAOM,IAAI,CAACH,OAAO,CAAC,cAAc;gBAChDC,MAAMA,QAAQ,SAASA,IAAID,OAAO,CAAC,WAAW,UAAUC,IAAID,OAAO,CAAC,qBAAqB;YAC3F,OAAO;gBACLH,OAAOM,IAAI,GAAGN,OAAOM,IAAI,CAACH,OAAO,CAAC,kCAAkC;gBACpEH,OAAOM,IAAI,IAAItB;gBACfoB,MAAMA,IAAID,OAAO,CAAC,8BAA8B;YAClD;YAEArB,OAAON,KAAK+B,OAAO,CAAC/B,KAAKS,IAAI,CAACK,QAAQkB,IAAI,EAAEN,UAAUE,OAAO;gBAC3D,IAAMK,WAAW,IAAI9B;gBACrB8B,SAASC,KAAK,CAAChC,GAAGiC,SAAS,CAACC,IAAI,CAAC,MAAMpC,KAAKS,IAAI,CAACK,QAAQkB,IAAI,EAAEN,UAAUE,MAAMJ,OAAOM,IAAI,EAAE;gBAC5F,CAAChB,QAAQuB,UAAU,IAAIJ,SAASC,KAAK,CAAChC,GAAGiC,SAAS,CAACC,IAAI,CAAC,MAAMpC,KAAKS,IAAI,CAACK,QAAQkB,IAAI,EAAE,AAAC,GAAgB,OAAdN,UAAUE,KAAI,UAAQJ,OAAOc,GAAG,EAAE;gBAC3HL,SAASM,KAAK,CAACxB;YACjB;QACF,EAAE,OAAOG,KAAK;YACZH,SAASG;QACX;IACF;AACF"}
{"version":3,"sources":["link.js"],"sourcesContent":["const path = require('path');\nconst fs = require('fs');\nconst Queue = require('queue-cb');\nconst mkdirp = require('mkdirp');\nconst unlink = require('./unlink');\n\nconst isWindows = process.platform === 'win32' || /^(msys|cygwin)$/.test(process.env.OSTYPE);\nconst symlinkType = isWindows ? 'junction' : 'dir';\n\nfunction saveLink(target, cb) {\n  const movedPath = path.join(path.dirname(target), `${path.basename(target)}.tsds`);\n  const queue = new Queue(1);\n  queue.defer(fs.rename.bind(null, target, movedPath));\n  queue.defer(createLink.bind(null, target));\n  queue.await(cb);\n}\n\nfunction createLink(target, cb) {\n  const queue = new Queue(1);\n  queue.defer((cb) => {\n    mkdirp(path.dirname(target), () => {\n      cb();\n    });\n  });\n  queue.defer(fs.symlink.bind(null, process.cwd(), target, symlinkType));\n  queue.await(cb);\n}\n\nfunction removeLink(target, cb) {\n  fs.unlink(target, cb);\n}\n\nmodule.exports = function link(target, cb) {\n  try {\n    fs.lstat(target, (_, lstat) => {\n      // new\n      if (!lstat) {\n        createLink(target, (err) => {\n          err ? cb(err) : cb(null, removeLink.bind(null, target));\n        });\n      }\n\n      // exists so move it\n      else if (lstat.isDirectory()) {\n        saveLink(target, (err) => {\n          err ? cb(err) : cb(null, unlink.bind(null, target));\n        });\n      }\n\n      // replace\n      else {\n        removeLink(target, () => {\n          createLink(target, (err) => {\n            err ? cb(err) : cb(null, removeLink.bind(null, target));\n          });\n        });\n      }\n    });\n  } catch (err) {\n    return cb(err);\n  }\n};\n"],"names":["path","require","fs","Queue","mkdirp","unlink","isWindows","process","platform","test","env","OSTYPE","symlinkType","saveLink","target","cb","movedPath","join","dirname","basename","queue","defer","rename","bind","createLink","await","symlink","cwd","removeLink","module","exports","link","lstat","_","err","isDirectory"],"mappings":";AAAA,IAAMA,OAAOC,QAAQ;AACrB,IAAMC,KAAKD,QAAQ;AACnB,IAAME,QAAQF,QAAQ;AACtB,IAAMG,SAASH,QAAQ;AACvB,IAAMI,SAASJ,QAAQ;AAEvB,IAAMK,YAAYC,QAAQC,QAAQ,KAAK,WAAW,kBAAkBC,IAAI,CAACF,QAAQG,GAAG,CAACC,MAAM;AAC3F,IAAMC,cAAcN,YAAY,aAAa;AAE7C,SAASO,SAASC,MAAM,EAAEC,EAAE;IAC1B,IAAMC,YAAYhB,KAAKiB,IAAI,CAACjB,KAAKkB,OAAO,CAACJ,SAAS,AAAC,GAAwB,OAAtBd,KAAKmB,QAAQ,CAACL,SAAQ;IAC3E,IAAMM,QAAQ,IAAIjB,MAAM;IACxBiB,MAAMC,KAAK,CAACnB,GAAGoB,MAAM,CAACC,IAAI,CAAC,MAAMT,QAAQE;IACzCI,MAAMC,KAAK,CAACG,WAAWD,IAAI,CAAC,MAAMT;IAClCM,MAAMK,KAAK,CAACV;AACd;AAEA,SAASS,WAAWV,MAAM,EAAEC,EAAE;IAC5B,IAAMK,QAAQ,IAAIjB,MAAM;IACxBiB,MAAMC,KAAK,CAAC,SAACN;QACXX,OAAOJ,KAAKkB,OAAO,CAACJ,SAAS;YAC3BC;QACF;IACF;IACAK,MAAMC,KAAK,CAACnB,GAAGwB,OAAO,CAACH,IAAI,CAAC,MAAMhB,QAAQoB,GAAG,IAAIb,QAAQF;IACzDQ,MAAMK,KAAK,CAACV;AACd;AAEA,SAASa,WAAWd,MAAM,EAAEC,EAAE;IAC5Bb,GAAGG,MAAM,CAACS,QAAQC;AACpB;AAEAc,OAAOC,OAAO,GAAG,SAASC,KAAKjB,MAAM,EAAEC,EAAE;IACvC,IAAI;QACFb,GAAG8B,KAAK,CAAClB,QAAQ,SAACmB,GAAGD;YACnB,MAAM;YACN,IAAI,CAACA,OAAO;gBACVR,WAAWV,QAAQ,SAACoB;oBAClBA,MAAMnB,GAAGmB,OAAOnB,GAAG,MAAMa,WAAWL,IAAI,CAAC,MAAMT;gBACjD;YACF,OAGK,IAAIkB,MAAMG,WAAW,IAAI;gBAC5BtB,SAASC,QAAQ,SAACoB;oBAChBA,MAAMnB,GAAGmB,OAAOnB,GAAG,MAAMV,OAAOkB,IAAI,CAAC,MAAMT;gBAC7C;YACF,OAGK;gBACHc,WAAWd,QAAQ;oBACjBU,WAAWV,QAAQ,SAACoB;wBAClBA,MAAMnB,GAAGmB,OAAOnB,GAAG,MAAMa,WAAWL,IAAI,CAAC,MAAMT;oBACjD;gBACF;YACF;QACF;IACF,EAAE,OAAOoB,KAAK;QACZ,OAAOnB,GAAGmB;IACZ;AACF"}
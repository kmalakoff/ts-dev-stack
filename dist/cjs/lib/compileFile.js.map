{"version":3,"sources":["compileFile.js"],"sourcesContent":["var path = require('path');\nvar fs = require('fs');\nvar Queue = require('queue-cb');\nvar once = require('call-once-fn');\nvar assign = require('just-extend');\nvar mkdirp = require('mkdirp');\n\nvar transformSync = require('ts-swc-loaders/lib/transformSync.js');\n\n// https://github.com/vercel/next.js/blob/20b63e13ab2631d6043277895d373aa31a1b327c/packages/next/taskfile-swc.js#L118-L125\nvar interopClientDefaultExport = [\n  '',\n  \"if ((typeof exports.default === 'function' || (typeof exports.default === 'object' && exports.default !== null)) && typeof exports.default.__esModule === 'undefined') {\",\n  \"  Object.defineProperty(exports.default, '__esModule', { value: true });\",\n  '  for (var key in exports) exports.default[key] = exports[key];',\n  '  module.exports = exports.default;',\n  '}',\n].join('\\n');\n\nmodule.exports = function compileFile(entry, options, callback) {\n  fs.readFile(entry.fullPath, 'utf8', function (err, contents) {\n    if (err) return callback(err);\n    callback = once(callback);\n\n    try {\n      var config = options.config;\n\n      // overrides for cjs\n      if (options.type === 'cjs') {\n        config = assign({}, config);\n        config.config = assign({}, config.config);\n        config.config.compilerOptions = assign({}, config.config.compilerOptions);\n        config.config.compilerOptions.module = 'CommonJS';\n        config.config.compilerOptions.target = 'ES5';\n      }\n\n      var output = transformSync(contents, entry.basename, config);\n      var relname = entry.path.replace(/\\.[^/.]+$/, '');\n      var ext = options.type === 'esm' ? '.mjs' : '.js';\n\n      // patch .mjs imports\n      if (options.type === 'esm') {\n        output.code = output.code.replace(/\\.(js|ts|tsx|mts)';/g, \".mjs';\");\n        output.code = output.code.replace(/\\.(cts)';/g, \".cjs';\");\n      }\n      // patch .js imports\n      else {\n        output.code = output.code.replace(/\\.(mjs|cjs|ts|tsx|mts|cts)\"\\)/g, '.js\")');\n        output.code += interopClientDefaultExport;\n      }\n\n      mkdirp(path.dirname(path.join(options.dest, relname + ext)), function () {\n        var outQueue = new Queue();\n        outQueue.defer(fs.writeFile.bind(null, path.join(options.dest, relname + ext), output.code, 'utf8'));\n        !options.sourceMaps || outQueue.defer(fs.writeFile.bind(null, path.join(options.dest, relname + ext + '.map'), output.map, 'utf8'));\n        outQueue.await(callback);\n      });\n    } catch (err) {\n      callback(err);\n    }\n  });\n};\n"],"names":["path","require","fs","Queue","once","assign","mkdirp","transformSync","interopClientDefaultExport","join","module","exports","compileFile","entry","options","callback","readFile","fullPath","err","contents","config","type","compilerOptions","target","output","basename","relname","replace","ext","code","dirname","dest","outQueue","defer","writeFile","bind","sourceMaps","map","await"],"mappings":";AAAA,IAAIA,OAAOC,QAAQ;AACnB,IAAIC,KAAKD,QAAQ;AACjB,IAAIE,QAAQF,QAAQ;AACpB,IAAIG,OAAOH,QAAQ;AACnB,IAAII,SAASJ,QAAQ;AACrB,IAAIK,SAASL,QAAQ;AAErB,IAAIM,gBAAgBN,QAAQ;AAE5B,0HAA0H;AAC1H,IAAIO,6BAA6B;IAC/B;IACA;IACA;IACA;IACA;IACA;CACD,CAACC,IAAI,CAAC;AAEPC,OAAOC,OAAO,GAAG,SAASC,YAAYC,KAAK,EAAEC,OAAO,EAAEC,QAAQ;IAC5Db,GAAGc,QAAQ,CAACH,MAAMI,QAAQ,EAAE,QAAQ,SAAUC,GAAG,EAAEC,QAAQ;QACzD,IAAID,KAAK,OAAOH,SAASG;QACzBH,WAAWX,KAAKW;QAEhB,IAAI;YACF,IAAIK,SAASN,QAAQM,MAAM;YAE3B,oBAAoB;YACpB,IAAIN,QAAQO,IAAI,KAAK,OAAO;gBAC1BD,SAASf,OAAO,CAAC,GAAGe;gBACpBA,OAAOA,MAAM,GAAGf,OAAO,CAAC,GAAGe,OAAOA,MAAM;gBACxCA,OAAOA,MAAM,CAACE,eAAe,GAAGjB,OAAO,CAAC,GAAGe,OAAOA,MAAM,CAACE,eAAe;gBACxEF,OAAOA,MAAM,CAACE,eAAe,CAACZ,MAAM,GAAG;gBACvCU,OAAOA,MAAM,CAACE,eAAe,CAACC,MAAM,GAAG;YACzC;YAEA,IAAIC,SAASjB,cAAcY,UAAUN,MAAMY,QAAQ,EAAEL;YACrD,IAAIM,UAAUb,MAAMb,IAAI,CAAC2B,OAAO,CAAC,aAAa;YAC9C,IAAIC,MAAMd,QAAQO,IAAI,KAAK,QAAQ,SAAS;YAE5C,qBAAqB;YACrB,IAAIP,QAAQO,IAAI,KAAK,OAAO;gBAC1BG,OAAOK,IAAI,GAAGL,OAAOK,IAAI,CAACF,OAAO,CAAC,wBAAwB;gBAC1DH,OAAOK,IAAI,GAAGL,OAAOK,IAAI,CAACF,OAAO,CAAC,cAAc;YAClD,OAEK;gBACHH,OAAOK,IAAI,GAAGL,OAAOK,IAAI,CAACF,OAAO,CAAC,kCAAkC;gBACpEH,OAAOK,IAAI,IAAIrB;YACjB;YAEAF,OAAON,KAAK8B,OAAO,CAAC9B,KAAKS,IAAI,CAACK,QAAQiB,IAAI,EAAEL,UAAUE,OAAO;gBAC3D,IAAII,WAAW,IAAI7B;gBACnB6B,SAASC,KAAK,CAAC/B,GAAGgC,SAAS,CAACC,IAAI,CAAC,MAAMnC,KAAKS,IAAI,CAACK,QAAQiB,IAAI,EAAEL,UAAUE,MAAMJ,OAAOK,IAAI,EAAE;gBAC5F,CAACf,QAAQsB,UAAU,IAAIJ,SAASC,KAAK,CAAC/B,GAAGgC,SAAS,CAACC,IAAI,CAAC,MAAMnC,KAAKS,IAAI,CAACK,QAAQiB,IAAI,EAAEL,UAAUE,MAAM,SAASJ,OAAOa,GAAG,EAAE;gBAC3HL,SAASM,KAAK,CAACvB;YACjB;QACF,EAAE,OAAOG,KAAK;YACZH,SAASG;QACX;IACF;AACF"}
{"version":3,"sources":["compileFile.js"],"sourcesContent":["const path = require('path');\nconst fs = require('fs');\nconst Queue = require('queue-cb');\nconst once = require('call-once-fn');\nconst assign = require('just-extend');\nconst mkdirp = require('mkdirp');\n\nconst { transformSync } = require('ts-swc-loaders');\n\nconst regexDependencies = require('./regexDependencies');\nconst regexESM = regexDependencies(true);\nconst regexCJS = regexDependencies();\n\nconst importReplaceMJS = ['.js', '.ts', '.tsx', '.mts', '.mjs'];\nconst importReplaceCJS = ['.cts'];\nconst requireReplaceJS = ['.mjs', '.cjs', '.ts', '.tsx', '.mts', '.cts'];\n\nfunction makeReplacements(code, regex, extensions, extension) {\n  let matches = [];\n  let match = regex.exec(code);\n  while (match) {\n    const dependency = match[1] || match[2] || match[3] || match[4];\n    const ext = extensions.find((x) => dependency.slice(-x.length) === x);\n    if (ext) matches.push({ ext, match, dependency });\n    match = regex.exec(code);\n  }\n\n  matches = matches.reverse();\n  for (const match of matches) {\n    const start = match.match.index + match.match[0].indexOf(match.dependency) + match.dependency.indexOf(match.ext);\n    code = code.substring(0, start) + extension + code.substring(start + match.ext.length);\n  }\n  return code;\n}\n\n// https://github.com/vercel/next.js/blob/20b63e13ab2631d6043277895d373aa31a1b327c/packages/next/taskfile-swc.js#L118-L125\nconst interopClientDefaultExport = [\n  '',\n  \"if ((typeof exports.default === 'function' || (typeof exports.default === 'object' && exports.default !== null)) && typeof exports.default.__esModule === 'undefined') {\",\n  \"  Object.defineProperty(exports.default, '__esModule', { value: true });\",\n  '  for (var key in exports) exports.default[key] = exports[key];',\n  '  module.exports = exports.default;',\n  '}',\n].join('\\n');\n\nmodule.exports = function compileFile(entry, options, callback) {\n  fs.readFile(entry.fullPath, 'utf8', (err, contents) => {\n    if (err) return callback(err);\n    callback = once(callback);\n\n    try {\n      let config = options.config;\n\n      // overrides for cjs\n      if (options.type === 'cjs') {\n        config = assign({}, config);\n        config.config = assign({}, config.config);\n        config.config.compilerOptions = assign({}, config.config.compilerOptions);\n        config.config.compilerOptions.module = 'CommonJS';\n        config.config.compilerOptions.target = 'ES5';\n      }\n\n      const output = transformSync(contents, entry.basename, config);\n      const relname = entry.path.replace(/\\.[^/.]+$/, '');\n      let ext = path.extname(entry.path);\n\n      // patch .mjs imports\n      if (options.type === 'esm') {\n        ext = importReplaceMJS.indexOf(ext) >= 0 ? '.mjs' : ext;\n        output.code = makeReplacements(output.code, regexESM, importReplaceMJS, '.mjs');\n        ext = importReplaceCJS.indexOf(ext) >= 0 ? '.cjs' : ext;\n        output.code = makeReplacements(output.code, regexESM, importReplaceCJS, '.cjs');\n      } else {\n        ext = requireReplaceJS.indexOf(ext) >= 0 ? '.js' : ext;\n        output.code = makeReplacements(output.code, regexCJS, requireReplaceJS, '.js');\n        output.code += interopClientDefaultExport;\n      }\n\n      mkdirp(path.dirname(path.join(options.dest, relname + ext)), () => {\n        const outQueue = new Queue();\n        outQueue.defer(fs.writeFile.bind(null, path.join(options.dest, relname + ext), output.code, 'utf8'));\n        !options.sourceMaps || outQueue.defer(fs.writeFile.bind(null, path.join(options.dest, `${relname + ext}.map`), output.map, 'utf8'));\n        outQueue.await(callback);\n      });\n    } catch (err) {\n      callback(err);\n    }\n  });\n};\n"],"names":["path","require","fs","Queue","once","assign","mkdirp","transformSync","regexDependencies","regexESM","regexCJS","importReplaceMJS","importReplaceCJS","requireReplaceJS","makeReplacements","code","regex","extensions","extension","dependency","match","ext","find","x","slice","length","matches","push","exec","reverse","start","index","indexOf","substring","interopClientDefaultExport","join","module","exports","compileFile","entry","options","callback","readFile","fullPath","err","contents","config","type","compilerOptions","target","output","basename","relname","replace","extname","dirname","dest","outQueue","defer","writeFile","bind","sourceMaps","map","await"],"mappings":"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"}
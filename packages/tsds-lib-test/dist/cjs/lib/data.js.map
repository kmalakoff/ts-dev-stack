{"version":3,"sources":["data.js"],"sourcesContent":["const fs = require('fs');\nconst path = require('path');\nconst Queue = require('queue-cb');\nconst spawn = require('cross-spawn-cb');\nconst access = require('fs-access-compat');\n\nconst tmpdir = require('os').tmpdir || require('os-shim').tmpdir;\nconst mkdirp = require('mkdirp');\nconst rimraf2 = require('rimraf2');\nconst shortHash = require('short-hash');\n\nconst dest = path.join(tmpdir(), 'tsds', shortHash(__dirname));\nmkdirp.sync(dest);\n\nmodule.exports = function data(git, options, callback) {\n  const packageName = path.basename(git, path.extname(git));\n  const packagePath = path.join(dest, packageName);\n  const tsdsPackagePath = path.resolve(packagePath, 'node_modules', 'ts-dev-stack');\n  const tsdsBinPath = path.resolve(packagePath, 'node_modules', '.bin', 'tsds');\n\n  // return callback(null, packagePath);\n\n  console.log('------------------');\n  console.log(`Preparing: ${packagePath}`);\n\n  access(packagePath, (err) => {\n    const queue = new Queue(1);\n\n    if (!err && options.clean) {\n      rimraf2.sync(packagePath, { disableGlob: true });\n      err = true;\n    }\n\n    // does not exist - clone\n    if (err) {\n      queue.defer(spawn.bind(null, 'git', ['clone', git], { stdio: 'inherit', cwd: dest }));\n    }\n    // exists - reset git\n    else {\n      queue.defer(spawn.bind(null, 'git', ['clean', '-fd'], { stdio: 'inherit', cwd: packagePath }));\n      queue.defer(spawn.bind(null, 'git', ['reset', '--hard', 'HEAD'], { stdio: 'inherit', cwd: packagePath }));\n      queue.defer(spawn.bind(null, 'git', ['pull', '--rebase'], { stdio: 'inherit', cwd: packagePath }));\n    }\n    queue.defer(spawn.bind(null, 'nvu', ['lts', '--silent', 'npm', 'install'], { stdio: 'inherit', cwd: packagePath }));\n\n    // link package\n    queue.defer(fs.rename.bind(null, tsdsPackagePath, `${tsdsPackagePath}.tsds`));\n    queue.defer(fs.symlink.bind(null, path.resolve(__dirname, '..', '..'), tsdsPackagePath, 'dir'));\n\n    // link bin\n    queue.defer(fs.rename.bind(null, tsdsBinPath, `${tsdsBinPath}.tsds`));\n    queue.defer(fs.symlink.bind(null, path.resolve(__dirname, '..', '..', 'bin', 'cli.js'), tsdsBinPath, 'file'));\n\n    queue.await((err) => {\n      console.log('------------------');\n      err ? callback(err) : callback(null, packagePath);\n    });\n  });\n};\n"],"names":["fs","require","path","Queue","spawn","access","tmpdir","mkdirp","rimraf2","shortHash","dest","join","__dirname","sync","module","exports","data","git","options","callback","packageName","basename","extname","packagePath","tsdsPackagePath","resolve","tsdsBinPath","console","log","err","queue","clean","disableGlob","defer","bind","stdio","cwd","rename","symlink","await"],"mappings":";AAAA,IAAMA,KAAKC,QAAQ;AACnB,IAAMC,OAAOD,QAAQ;AACrB,IAAME,QAAQF,QAAQ;AACtB,IAAMG,QAAQH,QAAQ;AACtB,IAAMI,SAASJ,QAAQ;AAEvB,IAAMK,SAASL,QAAQ,MAAMK,MAAM,IAAIL,QAAQ,WAAWK,MAAM;AAChE,IAAMC,SAASN,QAAQ;AACvB,IAAMO,UAAUP,QAAQ;AACxB,IAAMQ,YAAYR,QAAQ;AAE1B,IAAMS,OAAOR,KAAKS,IAAI,CAACL,UAAU,QAAQG,UAAUG;AACnDL,OAAOM,IAAI,CAACH;AAEZI,OAAOC,OAAO,GAAG,SAASC,KAAKC,GAAG,EAAEC,OAAO,EAAEC,QAAQ;IACnD,IAAMC,cAAclB,KAAKmB,QAAQ,CAACJ,KAAKf,KAAKoB,OAAO,CAACL;IACpD,IAAMM,cAAcrB,KAAKS,IAAI,CAACD,MAAMU;IACpC,IAAMI,kBAAkBtB,KAAKuB,OAAO,CAACF,aAAa,gBAAgB;IAClE,IAAMG,cAAcxB,KAAKuB,OAAO,CAACF,aAAa,gBAAgB,QAAQ;IAEtE,sCAAsC;IAEtCI,QAAQC,GAAG,CAAC;IACZD,QAAQC,GAAG,CAAC,AAAC,cAAyB,OAAZL;IAE1BlB,OAAOkB,aAAa,SAACM;QACnB,IAAMC,QAAQ,IAAI3B,MAAM;QAExB,IAAI,CAAC0B,OAAOX,QAAQa,KAAK,EAAE;YACzBvB,QAAQK,IAAI,CAACU,aAAa;gBAAES,aAAa;YAAK;YAC9CH,MAAM;QACR;QAEA,yBAAyB;QACzB,IAAIA,KAAK;YACPC,MAAMG,KAAK,CAAC7B,MAAM8B,IAAI,CAAC,MAAM,OAAO;gBAAC;gBAASjB;aAAI,EAAE;gBAAEkB,OAAO;gBAAWC,KAAK1B;YAAK;QACpF,OAEK;YACHoB,MAAMG,KAAK,CAAC7B,MAAM8B,IAAI,CAAC,MAAM,OAAO;gBAAC;gBAAS;aAAM,EAAE;gBAAEC,OAAO;gBAAWC,KAAKb;YAAY;YAC3FO,MAAMG,KAAK,CAAC7B,MAAM8B,IAAI,CAAC,MAAM,OAAO;gBAAC;gBAAS;gBAAU;aAAO,EAAE;gBAAEC,OAAO;gBAAWC,KAAKb;YAAY;YACtGO,MAAMG,KAAK,CAAC7B,MAAM8B,IAAI,CAAC,MAAM,OAAO;gBAAC;gBAAQ;aAAW,EAAE;gBAAEC,OAAO;gBAAWC,KAAKb;YAAY;QACjG;QACAO,MAAMG,KAAK,CAAC7B,MAAM8B,IAAI,CAAC,MAAM,OAAO;YAAC;YAAO;YAAY;YAAO;SAAU,EAAE;YAAEC,OAAO;YAAWC,KAAKb;QAAY;QAEhH,eAAe;QACfO,MAAMG,KAAK,CAACjC,GAAGqC,MAAM,CAACH,IAAI,CAAC,MAAMV,iBAAiB,AAAC,GAAkB,OAAhBA,iBAAgB;QACrEM,MAAMG,KAAK,CAACjC,GAAGsC,OAAO,CAACJ,IAAI,CAAC,MAAMhC,KAAKuB,OAAO,CAACb,WAAW,MAAM,OAAOY,iBAAiB;QAExF,WAAW;QACXM,MAAMG,KAAK,CAACjC,GAAGqC,MAAM,CAACH,IAAI,CAAC,MAAMR,aAAa,AAAC,GAAc,OAAZA,aAAY;QAC7DI,MAAMG,KAAK,CAACjC,GAAGsC,OAAO,CAACJ,IAAI,CAAC,MAAMhC,KAAKuB,OAAO,CAACb,WAAW,MAAM,MAAM,OAAO,WAAWc,aAAa;QAErGI,MAAMS,KAAK,CAAC,SAACV;YACXF,QAAQC,GAAG,CAAC;YACZC,MAAMV,SAASU,OAAOV,SAAS,MAAMI;QACvC;IACF;AACF"}
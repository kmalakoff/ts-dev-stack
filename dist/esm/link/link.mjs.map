{"version":3,"sources":["link.js"],"sourcesContent":["const path = require('node:path');\nconst fs = require('node:fs');\nconst Queue = require('queue-cb');\nconst mkdirp = require('mkdirp');\nconst unlink = require('../unlink/unlink');\n\nfunction saveLink(installPath, cb) {\n  const movedPath = path.join(path.dirname(installPath), `${path.basename(installPath)}.tsds`);\n  const queue = new Queue(1);\n  queue.defer(fs.rename.bind(null, installPath, movedPath));\n  queue.defer(createLink.bind(null, installPath));\n  queue.await(cb);\n}\n\nfunction createLink(installPath, cb) {\n  const queue = new Queue(1);\n  queue.defer((cb) => {\n    mkdirp(path.dirname(installPath), () => {\n      cb();\n    });\n  });\n  queue.defer(fs.symlink.bind(null, process.cwd(), installPath, 'dir'));\n  queue.await(cb);\n}\n\nfunction removeLink(installPath, cb) {\n  fs.unlink(installPath, cb);\n}\n\nmodule.exports = function link(installPath, cb) {\n  try {\n    fs.lstat(installPath, (_, lstat) => {\n      // new\n      if (!lstat) {\n        createLink(installPath, (err) => {\n          err ? cb(err) : cb(null, removeLink.bind(null, installPath));\n        });\n      }\n\n      // exists so move it\n      else if (lstat.isDirectory()) {\n        saveLink(installPath, (err) => {\n          err ? cb(err) : cb(null, unlink.bind(null, installPath));\n        });\n      }\n\n      // replace\n      else {\n        removeLink(installPath, () => {\n          createLink(installPath, (err) => {\n            err ? cb(err) : cb(null, removeLink.bind(null, installPath));\n          });\n        });\n      }\n    });\n  } catch (err) {\n    return cb(err);\n  }\n};\n"],"names":["path","require","fs","Queue","mkdirp","unlink","saveLink","installPath","cb","movedPath","join","dirname","basename","queue","defer","rename","bind","createLink","await","symlink","process","cwd","removeLink","module","exports","link","lstat","_","err","isDirectory"],"mappings":"AAAA,MAAMA,OAAOC,QAAQ;AACrB,MAAMC,KAAKD,QAAQ;AACnB,MAAME,QAAQF,QAAQ;AACtB,MAAMG,SAASH,QAAQ;AACvB,MAAMI,SAASJ,QAAQ;AAEvB,SAASK,SAASC,WAAW,EAAEC,EAAE;IAC/B,MAAMC,YAAYT,KAAKU,IAAI,CAACV,KAAKW,OAAO,CAACJ,cAAc,GAAGP,KAAKY,QAAQ,CAACL,aAAa,KAAK,CAAC;IAC3F,MAAMM,QAAQ,IAAIV,MAAM;IACxBU,MAAMC,KAAK,CAACZ,GAAGa,MAAM,CAACC,IAAI,CAAC,MAAMT,aAAaE;IAC9CI,MAAMC,KAAK,CAACG,WAAWD,IAAI,CAAC,MAAMT;IAClCM,MAAMK,KAAK,CAACV;AACd;AAEA,SAASS,WAAWV,WAAW,EAAEC,EAAE;IACjC,MAAMK,QAAQ,IAAIV,MAAM;IACxBU,MAAMC,KAAK,CAAC,CAACN;QACXJ,OAAOJ,KAAKW,OAAO,CAACJ,cAAc;YAChCC;QACF;IACF;IACAK,MAAMC,KAAK,CAACZ,GAAGiB,OAAO,CAACH,IAAI,CAAC,MAAMI,QAAQC,GAAG,IAAId,aAAa;IAC9DM,MAAMK,KAAK,CAACV;AACd;AAEA,SAASc,WAAWf,WAAW,EAAEC,EAAE;IACjCN,GAAGG,MAAM,CAACE,aAAaC;AACzB;AAEAe,OAAOC,OAAO,GAAG,SAASC,KAAKlB,WAAW,EAAEC,EAAE;IAC5C,IAAI;QACFN,GAAGwB,KAAK,CAACnB,aAAa,CAACoB,GAAGD;YACxB,MAAM;YACN,IAAI,CAACA,OAAO;gBACVT,WAAWV,aAAa,CAACqB;oBACvBA,MAAMpB,GAAGoB,OAAOpB,GAAG,MAAMc,WAAWN,IAAI,CAAC,MAAMT;gBACjD;YACF,OAGK,IAAImB,MAAMG,WAAW,IAAI;gBAC5BvB,SAASC,aAAa,CAACqB;oBACrBA,MAAMpB,GAAGoB,OAAOpB,GAAG,MAAMH,OAAOW,IAAI,CAAC,MAAMT;gBAC7C;YACF,OAGK;gBACHe,WAAWf,aAAa;oBACtBU,WAAWV,aAAa,CAACqB;wBACvBA,MAAMpB,GAAGoB,OAAOpB,GAAG,MAAMc,WAAWN,IAAI,CAAC,MAAMT;oBACjD;gBACF;YACF;QACF;IACF,EAAE,OAAOqB,KAAK;QACZ,OAAOpB,GAAGoB;IACZ;AACF"}
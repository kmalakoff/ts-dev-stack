{"version":3,"sources":["link.mjs"],"sourcesContent":["import fs from 'fs';\nimport path from 'path';\nimport mkdirp from 'mkdirp';\nimport Queue from 'queue-cb';\nimport unlink from './unlink.mjs';\n\nconst isWindows = process.platform === 'win32' || /^(msys|cygwin)$/.test(process.env.OSTYPE);\nconst symlinkType = isWindows ? 'junction' : 'dir';\n\nfunction saveLink(target, cb) {\n  const movedPath = path.join(path.dirname(target), `${path.basename(target)}.tsds`);\n  const queue = new Queue(1);\n  queue.defer(fs.rename.bind(null, target, movedPath));\n  queue.defer(createLink.bind(null, target));\n  queue.await(cb);\n}\n\nfunction createLink(target, cb) {\n  const queue = new Queue(1);\n  queue.defer((cb) => {\n    mkdirp(path.dirname(target), () => {\n      cb();\n    });\n  });\n  queue.defer(fs.symlink.bind(null, process.cwd(), target, symlinkType));\n  queue.await(cb);\n}\n\nfunction removeLink(target, cb) {\n  fs.unlink(target, cb);\n}\n\nexport default function link(target, cb) {\n  try {\n    fs.lstat(target, (_, lstat) => {\n      // new\n      if (!lstat) {\n        createLink(target, (err) => {\n          err ? cb(err) : cb(null, removeLink.bind(null, target));\n        });\n      }\n\n      // exists so move it\n      else if (lstat.isDirectory()) {\n        saveLink(target, (err) => {\n          err ? cb(err) : cb(null, unlink.bind(null, target));\n        });\n      }\n\n      // replace\n      else {\n        removeLink(target, () => {\n          createLink(target, (err) => {\n            err ? cb(err) : cb(null, removeLink.bind(null, target));\n          });\n        });\n      }\n    });\n  } catch (err) {\n    return cb(err);\n  }\n}\n"],"names":["fs","path","mkdirp","Queue","unlink","isWindows","process","platform","test","env","OSTYPE","symlinkType","saveLink","target","cb","movedPath","join","dirname","basename","queue","defer","rename","bind","createLink","await","symlink","cwd","removeLink","link","lstat","_","err","isDirectory"],"mappings":"AAAA,OAAOA,QAAQ,KAAK;AACpB,OAAOC,UAAU,OAAO;AACxB,OAAOC,YAAY,SAAS;AAC5B,OAAOC,WAAW,WAAW;AAC7B,OAAOC,YAAY,eAAe;AAElC,MAAMC,YAAYC,QAAQC,QAAQ,KAAK,WAAW,kBAAkBC,IAAI,CAACF,QAAQG,GAAG,CAACC,MAAM;AAC3F,MAAMC,cAAcN,YAAY,aAAa;AAE7C,SAASO,SAASC,MAAM,EAAEC,EAAE;IAC1B,MAAMC,YAAYd,KAAKe,IAAI,CAACf,KAAKgB,OAAO,CAACJ,SAAS,GAAGZ,KAAKiB,QAAQ,CAACL,QAAQ,KAAK,CAAC;IACjF,MAAMM,QAAQ,IAAIhB,MAAM;IACxBgB,MAAMC,KAAK,CAACpB,GAAGqB,MAAM,CAACC,IAAI,CAAC,MAAMT,QAAQE;IACzCI,MAAMC,KAAK,CAACG,WAAWD,IAAI,CAAC,MAAMT;IAClCM,MAAMK,KAAK,CAACV;AACd;AAEA,SAASS,WAAWV,MAAM,EAAEC,EAAE;IAC5B,MAAMK,QAAQ,IAAIhB,MAAM;IACxBgB,MAAMC,KAAK,CAAC,CAACN;QACXZ,OAAOD,KAAKgB,OAAO,CAACJ,SAAS;YAC3BC;QACF;IACF;IACAK,MAAMC,KAAK,CAACpB,GAAGyB,OAAO,CAACH,IAAI,CAAC,MAAMhB,QAAQoB,GAAG,IAAIb,QAAQF;IACzDQ,MAAMK,KAAK,CAACV;AACd;AAEA,SAASa,WAAWd,MAAM,EAAEC,EAAE;IAC5Bd,GAAGI,MAAM,CAACS,QAAQC;AACpB;AAEA,eAAe,SAASc,KAAKf,MAAM,EAAEC,EAAE;IACrC,IAAI;QACFd,GAAG6B,KAAK,CAAChB,QAAQ,CAACiB,GAAGD;YACnB,MAAM;YACN,IAAI,CAACA,OAAO;gBACVN,WAAWV,QAAQ,CAACkB;oBAClBA,MAAMjB,GAAGiB,OAAOjB,GAAG,MAAMa,WAAWL,IAAI,CAAC,MAAMT;gBACjD;YACF,OAGK,IAAIgB,MAAMG,WAAW,IAAI;gBAC5BpB,SAASC,QAAQ,CAACkB;oBAChBA,MAAMjB,GAAGiB,OAAOjB,GAAG,MAAMV,OAAOkB,IAAI,CAAC,MAAMT;gBAC7C;YACF,OAGK;gBACHc,WAAWd,QAAQ;oBACjBU,WAAWV,QAAQ,CAACkB;wBAClBA,MAAMjB,GAAGiB,OAAOjB,GAAG,MAAMa,WAAWL,IAAI,CAAC,MAAMT;oBACjD;gBACF;YACF;QACF;IACF,EAAE,OAAOkB,KAAK;QACZ,OAAOjB,GAAGiB;IACZ;AACF"}